<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
    <h1>결제 페이지</h1>
    <button id="payment-button">결제하기</button>

    <script>
        var IMP = window.IMP;
        IMP.init("imp06350358"); // 자신의 "가맹점 식별코드"를 사용

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('payment-button').addEventListener('click', async function() {
                // 백엔드에서 결제 정보 가져오기
                const response = await fetch('/payments/prepare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        course_id: 1,  // 정수여야 함
                        method: 'CREDIT_CARD'  // PaymentMethod enum의 유효한 값이어야 함
                    }),
                });
                const paymentData = await response.json();

                IMP.request_pay({
                    pg: "inicis_v2",
                    pay_method: "card",
                    merchant_uid: paymentData.merchant_uid,
                    name: paymentData.name,
                    amount: paymentData.amount,
                    buyer_email: paymentData.buyer_email,
                    buyer_name: paymentData.buyer_name,
                }, async function (rsp) {
                    if (rsp.success) {
                        // 결제 성공 시 백엔드에 확인 요청
                        const confirmResponse = await fetch('payments/confirm', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                imp_uid: rsp.imp_uid,
                                merchant_uid: rsp.merchant_uid
                            }),
                        });
                        const confirmResult = await confirmResponse.json();
                        console.log("결제 성공", confirmResult);
                    } else {
                        console.log("결제 실패", rsp);
                    }
                });
            });
        });
    </script>
</body>
</html>